---
title: "modelo econometrico"
author: "Ana Munoz"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
# LIBRERIA USADAS
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(corrplot)
library(psych)
library(ggplot2)
library(fitdistrplus)
library(plm)
library(lmtest)
```

# Pre procesamiento de datos
## 1. Lectura de datos y formato panel

```{r}
df <- read.csv('df_17_21_noclean.csv') %>%
  dplyr::select(year, country, total_earnings, # orden de datos panel
         total_players,
         -iso, -code, #no aplica el modelo
         pbicap, 
         gdp_gr,
         CPI, # corrupcion
         internet, elect_acc,
         exp_tech, # tech access
         -age_work,
         life_exp, # edades
         poblacion# people
        ) %>%
  arrange(country, decreasing = FALSE)



head(df, 3)
```

## 2.  Valores faltantes
* Numero de Valores faltantes por variable
```{r}
sapply(df, function(x) sum(is.na(x)))
```
* corriegiendo los NAs
```{r}
# Pbi faltantes 
## "Cuba"  "Lebanon"  "Syrian Arab Republic"  "Venezuela"  
pbicap_faltantes <- unique(df[is.na(df$pbicap), ]$country)
df <- df[!df$country %in% pbicap_faltantes, ]

# Internet: 2 faltantes -> 2018 cambodia y trinidad y tobago

### Cambodia, hueco en 2018, reemplazdo por el promedio

df[df$country=='Cambodia', 'internet'][2] <- 
          (df[df$country=='Cambodia', 'internet'][1] + 
             df[df$country=='Cambodia', 'internet'][3])/2

### trinidad y tobago, reemplazdo por el promedio
df[df$country=='Trinidad and Tobago', 'internet'][2] <- 
          (df[df$country=='Trinidad and Tobago', 'internet'][1]+
              df[df$country=='Trinidad and Tobago', 'internet'][3])/2

# Acceso a electricidad y life expectanci solo antes del 2022
df <- df %>%
  filter(year < as.Date("2022-01-01"))

# EXportacion tecnologica voy a quitar a los paises que no tiene exportacion por temas politicos
##"Iran, Islamic Republic of" "United Arab Emirates" "Viet Nam"   
exp_faltantes <- unique(df[is.na(df$exp_tech), ]$country)
df <- df[!df$country %in% exp_faltantes, ]


# CPI macao no tiene por temas politicos
df <- df[df$country != 'Macao', ]


### Jugadores por poblacion por millon
df$players_ppl <- (df$total_players/df$poblacion)*1000000

###########

# verificamos NAs, ahora no tengo NAS
sapply(df, function(x) sum(is.na(x)))
```
## 3.  Normalizacion con logaritmo

* valores con varianzas muy grandes

```{r}
summary(df)
```
* aplico normalizacion logaritmica en algunas variables
```{r}
df_standar <- df %>% 
   mutate(across(c("total_earnings", "pbicap", "poblacion"), ~log(.) %>% as.vector))
```

## 4. Correlacion y eliminacion de variables
* verificacion de correlaciones
```{r}
matriz_corr <- cor(df_standar[3:13])
corrplot(matriz_corr, method = 'number', number.cex = 0.8) 
```

* Veamos mas a detalle las correlaciones encontradas,  pbippa,  cpi e acceso internet
 Se debe crear otra variable para eliminar la correlacion?
 estas correlaciones no implican causalidad, pero como debo tratarlas?
```{r}
pairs.panels(df_standar%>%dplyr::select(total_earnings,players_ppl, pbicap, internet,CPI),
             smooth = FALSE,     # Si TRUE, dibuja ajuste suavizados de tipo loess
             scale = FALSE,      # Si TRUE, escala la fuente al grado de correlación
             density = TRUE,     # Si TRUE, añade histogramas y curvas de densidad
             ellipses = FALSE,   # Si TRUE, dibuja elipses
             method = "pearson", # Método de correlación (también "spearman" o "kendall")
             lm = TRUE,          # Si TRUE, dibuja un ajuste lineal en lugar de un ajuste LOESS
             cor = TRUE,         # Si TRUE, agrega correlaciones
             jiggle = FALSE,     # Si TRUE, se añade ruido a los dato
) 

```

# Implementando modelos

## 0. Preparando los datos
* tenemos datos panel con la siguente forma 90 paises 5 anios y estas cols
```{r}
# df_panel <- df_standar %>% select(-c(total_players))
# por si sera necesario quitar algunas var
dim(table(df_standar$country,df_standar$year))

colnames(df_standar)
```

* definimos las variables para el modelo
```{r, warning=FALSE}
attach(df_standar)
Y <- cbind(total_earnings)
X <- cbind(pbicap, gdp_gr, CPI, internet,exp_tech,
           elect_acc, life_exp, poblacion, players_ppl)

df_panel <- pdata.frame(df_standar, 
                        index=c('country','year'))

head(df_panel,3)
```

## 4. Efectos Fijos
```{r}
fijos <- plm(Y ~ X, data=df_panel, model= "within")
summary(fijos)
```

## 5. Efectos aleatorios
```{r}
random <- plm(Y ~ X, data=df_panel, model= "random")
summary(random)
```


# Test

## Hausman test for fijos versus random effects model

```{r}
phtest(fijos, random)
```
