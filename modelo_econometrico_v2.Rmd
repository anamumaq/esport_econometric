---
title: "modelo econometrico"
author: "Ana Munoz"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
# LIBRERIA USADAS
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(corrplot)
library(psych)
library(ggplot2)
library(fitdistrplus)
library(plm)
library(lmtest)
library(car)
```

# Pre procesamiento de datos
## 1. Lectura de datos y formato panel

```{r}
df <- read.csv('df_17_21_noclean.csv') %>%
  dplyr::select(year, country, total_earnings, # orden de datos panel
         total_players,
         -iso, -code, #no aplica el modelo
         pbicap, 
         gdp_gr,
         CPI, # corrupcion
         internet, elect_acc,
         exp_tech, # tech access
         -age_work,
         life_exp, # edades
         poblacion# people
        ) %>%
  arrange(country, decreasing = FALSE)


head(df, 3)
```

## 2.  Valores faltantes
* Numero de Valores faltantes por variable
```{r}
sapply(df, function(x) sum(is.na(x)))
```
* corriegiendo los NAs
```{r}
# Pbi faltantes 
## "Cuba"  "Lebanon"  "Syrian Arab Republic"  "Venezuela"  
pbicap_faltantes <- unique(df[is.na(df$pbicap), ]$country)
df <- df[!df$country %in% pbicap_faltantes, ]

# Internet: 2 faltantes -> 2018 cambodia y trinidad y tobago

### Cambodia, hueco en 2018, reemplazdo por el promedio

df[df$country=='Cambodia', 'internet'][2] <- 
          (df[df$country=='Cambodia', 'internet'][1] + 
             df[df$country=='Cambodia', 'internet'][3])/2

### trinidad y tobago, reemplazdo por el promedio
df[df$country=='Trinidad and Tobago', 'internet'][2] <- 
          (df[df$country=='Trinidad and Tobago', 'internet'][1]+
              df[df$country=='Trinidad and Tobago', 'internet'][3])/2

# Acceso a electricidad y life expectanci solo antes del 2022
df <- df %>%
  filter(year < as.Date("2022-01-01"))

# EXportacion tecnologica voy a quitar a los paises que no tiene exportacion por temas politicos
##"Iran, Islamic Republic of" "United Arab Emirates" "Viet Nam"   
exp_faltantes <- unique(df[is.na(df$exp_tech), ]$country)
df <- df[!df$country %in% exp_faltantes, ]


# CPI macao no tiene por temas politicos
df <- df[df$country != 'Macao', ]


### Jugadores por poblacion por millon
df$players_ppl <- (df$total_players/df$poblacion)*1000000

###########

# verificamos NAs, ahora no tengo NAS
sapply(df, function(x) sum(is.na(x)))
```
## 3.  Normalizacion con logaritmo

* valores con varianzas muy grandes

```{r}
summary(df)
```
* aplico normalizacion logaritmica en algunas variables
```{r}
df_standar <- df %>% 
   mutate(across(c("total_earnings", "pbicap", "poblacion"), ~log(.) %>% as.vector))
```

# EDA varibales
```{r}
head(df_standar)
```

```{r}
ggplot(df_standar, aes(x = year, y = total_earnings)) +
  geom_boxplot()
```

```{r}
median_earnings <- aggregate(total_earnings ~ country, df_standar, median)
df_eda <- merge(df_standar, median_earnings, by = "country", suffixes = c("", "_median"))
```


```{r}
ggplot(df_eda, aes(x = players_ppl, y = total_earnings, color = total_earnings_median)) +
  geom_point() +
  facet_wrap(~ year) +
  scale_color_gradient(low = "red", high = "green") +  # Puedes cambiar los colores a tu gusto
  theme(legend.position = "none")  # Esto oculta la leyenda
```

```{r}
ggplot(df_eda, aes(x = pbicap, y = total_earnings, color = total_earnings_median)) + 
  geom_point() +
  facet_wrap(~ year) +
  scale_color_gradient(low = "red", high = "green")+
  labs(x = "pbicap", y = "Ganancias") +
  theme(legend.position = "none")+
  ggtitle("Ganancias en videojuegos a lo largo del tiempo por país")
```

```{r}
ggplot(df_eda, aes(x = gdp_gr, y = total_earnings, color = total_earnings_median)) + 
  geom_point() +
  facet_wrap(~ year) +
  scale_color_gradient(low = "red", high = "green")+
  labs(x = "gdp_gr", y = "Ganancias") +
  theme(legend.position = "none")+
  ggtitle("Ganancias en videojuegos a lo largo del tiempo por país")
```
```{r}
ggplot(df_eda, aes(x = CPI, y = total_earnings, color = total_earnings_median)) + 
  geom_point() +
  facet_wrap(~ year) +
  scale_color_gradient(low = "red", high = "green")+
  labs(x = "CPI", y = "Ganancias") +
  theme(legend.position = "none")+
  ggtitle("Ganancias en videojuegos a lo largo del tiempo por país")
```
```{r}

ggplot(df_eda, aes(x = internet, y = total_earnings, color = total_earnings_median)) + 
  geom_point() +
  facet_wrap(~ year) +
  scale_color_gradient(low = "red", high = "green")+
  labs(x = "internet", y = "Ganancias") +
  theme(legend.position = "none")+
  ggtitle("Ganancias en videojuegos a lo largo del tiempo por país")

```
```{r}
ggplot(df_eda, aes(x = elect_acc, y = total_earnings, color = total_earnings_median)) + 
  geom_point() +
  facet_wrap(~ year) +
  scale_color_gradient(low = "red", high = "green")+
  labs(x = "elect_acc", y = "Ganancias") +
  theme(legend.position = "none")+
  ggtitle("Ganancias en videojuegos a lo largo del tiempo por país")
```
```{r}
ggplot(df_eda, aes(x = life_exp, y = total_earnings, color = total_earnings_median)) + 
  geom_point() +
  facet_wrap(~ year) +
  scale_color_gradient(low = "red", high = "green")+
  labs(x = "life_exp", y = "Ganancias") +
  theme(legend.position = "none")+
  ggtitle("Ganancias en videojuegos a lo largo del tiempo por país")
```
```{r}
ggplot(df_eda, aes(x = poblacion, y = total_earnings, color = total_earnings_median)) + 
  geom_point() +
  facet_wrap(~ year) +
  scale_color_gradient(low = "red", high = "green")+
  labs(x = "poblacion", y = "Ganancias") +
  theme(legend.position = "none")+
  ggtitle("Ganancias en videojuegos a lo largo del tiempo por país")

```

# Implementando modelos

## 0. Preparando los datos
* tenemos datos panel con la siguente forma 90 paises 5 anios y estas cols
* Nuestro panel es balanceado y corto
```{r}
# df_panel <- df_standar %>% select(-c(total_players))
# por si sera necesario quitar algunas var
dim(table(df_standar$country,df_standar$year))

colnames(df_standar)
```

* definimos las variables para el modelo
```{r, warning=FALSE}
attach(df_standar)
Y <- cbind(total_earnings)
X <- cbind(pbicap, gdp_gr, internet, 
           exp_tech, 
           #CPI, 
          elect_acc, 
           life_exp, poblacion, players_ppl)

df_panel <- pdata.frame(df_standar,
                        index=c('country','year')
                        )
# [, c('total_earnings', 'pbicap', 'gdp_gr', 'internet',
#                'exp_tech', 'CPI', 'elect_acc', 'life_exp', 
#                'poblacion', 'players_ppl')]

head(df_panel,3)
```

## 4. Efectos Fijos
```{r}
fijos <- plm(Y ~ X, data=df_panel, model= "within")
summary(fijos)
```

## 5. Efectos aleatorios
```{r}
random <- plm(Y ~ X, data=df_panel, model= "random")
summary(random)
```


# Test

## 1. Breusch-Pagan
* Mediante plmtest se realiza el contraste con hipótesis nula el modelo agrupado es mejor que el de efectos aleatorios. En este caso se rechaza dicha hipótesis (p-valor menor que 0.05 ya que es menor que 2·10^(-16)), luego los efectos aleatorios son preferibles.
```{r}
plmtest(random, type=c("bp"))
```

## Hausman test for fijos versus random effects model

* Mediante phtest se realiza el contraste de Hausman con hipótesis nula el modelo de efectos aleatorios es mejor que el de efectos fijos. En este caso se rechaza dicha hipótesis (p-valor=0.000000005492<0.05), luego los efectos fijos son preferibles.
```{r}
phtest(fijos, random)
```
################################################################

## F test
* Mediante pFtest se realiza el contraste con hipótesis nula el modelo agrupado es mejor que el de efectos fijos. En este caso se rechaza dicha hipótesis (p-valor menor que 0.05 ----------), luego los efectos fijos son preferibles.
```{r}
pFtest(fijos, random) 
```

# Efectos fijos
```{r}
fixef(fijos) # efectos individuales de cada individuo
```
# Analizando multicolinealidad VIF

```{r}
df_panel
```

```{r}
# vifinf(X)
ls.str("vifinf")
```

