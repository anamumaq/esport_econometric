---
title: "Modelo econometrico suspuestos"
author: "Ana Munoz"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
# LIBRERIA USADAS
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(corrplot)
library(psych)
library(ggplot2)
library(fitdistrplus)
library(plm)
library(lmtest)
library(car)
library(lubridate)
```

# Pre procesamiento de datos
## 1. Lectura de datos y formato panel

```{r}
df <- read.csv('df_17_21_noclean.csv') %>%
  dplyr::select(year, country, total_earnings, # orden de datos panel
         total_players,
         pbicap, 
         internet, 
         desempleo,
         pea, # tech access
         life_exp, # edades
         poblacion,# people
         inflacion
        ) %>%
  arrange(country, decreasing = FALSE)

head(df, 3)
```

## 2.  Valores faltantes
* Numero de Valores faltantes por variable
```{r}
sapply(df, function(x) sum(is.na(x)))
```

* corriegiendo los NAs
```{r}
# Pbi faltantes 
## "Cuba"  "Lebanon"  "Syrian Arab Republic"  "Venezuela"  
pbicap_faltantes <- unique(df[is.na(df$pbicap), ]$country)
df <- df[!df$country %in% pbicap_faltantes, ]

# Internet: 2 faltantes -> 2018 cambodia y trinidad y tobago

### Cambodia, hueco en 2018, reemplazdo por el promedio

df[df$country=='Cambodia', 'internet'][2] <- 
          (df[df$country=='Cambodia', 'internet'][1] + 
             df[df$country=='Cambodia', 'internet'][3])/2

### trinidad y tobago, reemplazdo por el promedio
df[df$country=='Trinidad and Tobago', 'internet'][2] <- 
          (df[df$country=='Trinidad and Tobago', 'internet'][1]+
              df[df$country=='Trinidad and Tobago', 'internet'][3])/2

# Acceso a electricidad y life expectanci solo antes del 2022
df <- df %>%
  filter(year < as.Date("2022-01-01"))

##"Iran, Islamic Republic of" "United Arab Emirates" "Viet Nam"   
# exp_faltantes <- unique(df[is.na(df$exp_tech), ]$country)
# df <- df[!df$country %in% exp_faltantes, ]
df <- df[!df$country %in% c("Iran", "Islamic Republic of", "United Arab Emirates", "Viet Nam"), ]    

# CPI macao no tiene por temas politicos
df <- df[df$country != 'Macao', ]

# Migation Hong Kong considerado dentro del gobierno de cina
df <- df[df$country != 'Hong Kong', ]

###########

# verificamos NAs, ahora no tengo NAS
sapply(df, function(x) sum(is.nan(x)))
```



## 3.  Normalizacion con logaritmo


* valores con varianzas muy grandes
* aplico normalizacion logaritmica en algunas variables

```{r}
df_standar <- df %>% 
  mutate(across(c("total_earnings", "pbicap", "poblacion", "pea", "total_players"), ~log(.)))%>%
  # mutate(across(c("total_earnings", "pbicap", "poblacion", "pea", "total_players"), ~sqrt(.))) %>%
  mutate(year = year(df$year))

```

```{r}
df_standar$players_ppl <- (df_standar$total_players/df_standar$poblacion)

summary(df_standar)

```

## 0. Preparando los datos

```{r}
df_standar %>% 
  group_by(year) %>% 
  summarise(count = n())
```

* Tenemos datos panel con la siguente forma 90 paises 5 anios y estas columnas
* Nuestro panel es balanceado y corto
```{r}
dim(table(df_standar$country,df_standar$year))

colnames(df_standar)
```

* definimos las variables para el modelo
```{r, warning=FALSE}
attach(df_standar)
Y <- cbind(total_earnings)
X <- cbind(pbicap, 
           internet, 
           life_exp,
           pea,
           desempleo, 
           poblacion,
           inflacion,
           # total_players,
           players_ppl
           )

df_panel <- pdata.frame(df_standar,
                        index=c('country','year'))

head(df_panel,3)
```

## 1. Efectos Fijos
```{r}
fijos <- plm(Y ~ X, data=df_panel, index=c('country','year'), model= "within")
summary(fijos)
```

## 2. Efectos aleatorios
```{r}
random <- plm(Y ~ X, data=df_panel, index=c('country','year'), model= "random")
summary(random)
```
## 3. MCO

```{r}
mco_pool = plm(Y ~ X, data=df_panel,index=c("state", "year"), model="pooling")
mco = lm(Y ~ X, data=df_panel)
# summary(mco)
```

# Test para escoger el mejor modelo

## 1. F test
*  H0: modelo (MCO) vs H1: efectos fijos
* p<0.05 entonces rechazo Ho, el mejor modelo seria efectos fijos
```{r}
pFtest(fijos, mco) 
```

## 2. Breusch-Pagan
* H0: modelo agrupado (MCO) vs H1: efectos aleatorios
* p<0.05 entonces rechazo la Ho, por ahora el mejor modelo seria aleatorios
```{r}
plmtest(mco_pool, type=c("bp"))
```

## 3. Hausman test 
* H0: efectos aleatorios vs H1: efectos fijos
* p<0.05 entonces rechazo Ho y decido que efectos fijos es mejor
```{r}
phtest(fijos, random)
```

# Regresiones
## Regresieon con efectos fijos

### by Country Spain

```{r}
df_panel$country <- relevel(df_panel$country, ref = "Spain")
regresion_country_sp = lm(Y ~ X + factor(country), data = df_panel)

# summary(regresion_country)


p_values <- summary(regresion_country_sp)$coefficients[,4]
coeficiente <- summary(regresion_country_sp)$coefficients[,1]

no_significativo <- names(p_values)[which(p_values > 0.05)]

significativo_positivos <- names(p_values)[which(p_values < 0.05 & coeficiente>0)]

significativo_negativos <- names(p_values)[which(p_values < 0.05 & coeficiente<0)]
```

### Analizando significancias
```{r}
no_significativo
```

```{r}
significativo_positivos
```

```{r}
significativo_negativos
```

### Supuestos
* normalidad
```{r}
# summary(regresion_country_sp)
shapiro.test(resid(regresion_country_sp))

```

*homocedasticidad
```{r}

bptest(regresion_country_sp)

```

```{r}
dwtest(regresion_country_sp)

```
* multicolinealidad
```{r}

vif(regresion_country_sp)
```




### By year
* El año en sí mismo no parece tener un efecto significativo en Y después de ajustar por X
```{r}
regresion_years = lm(Y~X+factor(year))
summary(regresion_years)
```
