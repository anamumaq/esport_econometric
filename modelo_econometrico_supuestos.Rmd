---
title: "Modelo econometrico suspuestos"
author: "Ana Munoz"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
# LIBRERIA USADAS
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(corrplot)
library(psych)
library(ggplot2)
library(fitdistrplus)
library(plm)
library(lmtest)
library(car)
library(lubridate)
```

# Pre procesamiento de datos
## 1. Lectura de datos y formato panel

```{r}
df <- read.csv('df_17_21_noclean.csv') %>%
# df <- read.csv('df_00_21_noclean.csv') %>%
  dplyr::select(year, country, total_earnings, # orden de datos panel
         total_players,
         pbicap, 
         internet, 
         desempleo,
         pea, 
         life_exp, 
         poblacion,# people
         inflacion
        ) %>%
  # mutate(year = as.Date(year, format = "%d/%m/%Y"))%>%
  arrange(country, decreasing = FALSE)

head(df, 3)
```

## 2.  Valores faltantes
* Numero de Valores faltantes por variable
```{r}
df %>% 
  group_by(year) %>% 
  summarise(count = n())

```


```{r}
sapply(df, function(x) sum(is.na(x)))
```

* corriegiendo los NAs
```{r}

# Acceso a electricidad y life expectanci solo antes del 2022
df <- df %>%
  filter(year < as.Date("2022-01-01"))
# & year > as.Date("2014-01-01"))

# Pbi faltantes 
## "Cuba"  "Lebanon"  "Syrian Arab Republic"  "Venezuela"  
pbicap_faltantes <- unique(df[is.na(df$pbicap), ]$country)
df <- df[!df$country %in% pbicap_faltantes, ]

# Internet: 2 faltantes -> 2018 cambodia y trinidad y tobago


df <- df[!df$country %in% c( #"Cyprus",#por solo estar en el 2022
                             # "Afghanistan", 
                             "Cambodia","Syrian Arab Republic","Trinidad and Tobago" ), ]
 ### Cambodia, hueco en 2018, reemplazdo por el promedio

# df[df$country=='Cambodia', 'internet'][2] <- 
#           (df[df$country=='Cambodia', 'internet'][1] + 
#              df[df$country=='Cambodia', 'internet'][3])/2

### trinidad y tobago, reemplazdo por el promedio
# df[df$country=='Trinidad and Tobago', 'internet'][2] <- 
#           (df[df$country=='Trinidad and Tobago', 'internet'][1]+
#               df[df$country=='Trinidad and Tobago', 'internet'][3])/2



##"Iran, Islamic Republic of" "United Arab Emirates" "Viet Nam"   
# exp_faltantes <- unique(df[is.na(df$exp_tech), ]$country)
# df <- df[!df$country %in% exp_faltantes, ]
# df <- df[!df$country %in% c("Iran", "Islamic Republic of", "United Arab Emirates", "Viet Nam"), ]    

# CPI macao no tiene por temas politicos
# df <- df[df$country != 'Macao', ]

# Migation Hong Kong considerado dentro del gobierno de cina
# df <- df[df$country != 'Hong Kong', ]

# verificamos NAs, ahora no tengo NAS
sapply(df, function(x) sum(is.nan(x)))



```
```{r}


# nuevas variables
df$TJ_POB <- (df$TJ/df$POB)
df$PEA_POB <- (df$PEA/df$POB)
```


## 3.  Normalizacion con logaritmo


* valores con varianzas muy grandes
* aplico normalizacion logaritmica en algunas variables

```{r}
df_standar <- df %>% 
  mutate(across(c("TG", "PIBc", "POB", "PEA", "TJ", "TJ_POB", "PEA_POB"), ~log(.)))%>%
  mutate(year = year(df$year))

```

```{r}
summary(df_standar)
```

## 0. Preparando los datos

```{r}
df_standar %>% 
  group_by(year) %>% 
  summarise(count = n())
```

* Tenemos datos panel con la siguente forma 90 paises 5 anios y estas columnas
* Nuestro panel es balanceado y corto
```{r}
dim(table(df_standar$pais,df_standar$year))

colnames(df_standar)
```

* definimos las variables para el modelo
```{r, warning=FALSE}
attach(df_standar)
Y <- cbind(TG)
X <- cbind(PIBc, 
           INT, 
           #life_exp,
           #PEA,
           DEmp, 
           #POB,
           INF,
           # TJ,
           TJ_POB,
           PEA_POB
           )

df_panel <- pdata.frame(df_standar,
                        index=c('pais','year'))


datos_2 = data.frame(Y, X, pais)
write.table(datos_2, "02_datos.txt", sep=";", row.names=F)	
# library(xlsx)
# write.xlsx(datos_2, "02_datos.xlsx", sheetName="datos", append=FALSE, row.names=F)

head(df_panel,3)
```

## 1. Efectos Fijos
```{r}
fijos <- plm(Y ~ X, data=df_panel, index=c('pais','year'), model= "within")
summary(fijos)
```

## 2. Efectos aleatorios
```{r}
random <- plm(Y ~ X, data=df_panel, index=c('pais','year'), model= "random")
summary(random)
```
## 3. MCO

```{r}
mco_pool = plm(Y ~ X, data=df_panel,index=c("state", "year"), model="pooling")
mco = lm(Y ~ X, data=df_panel)
# summary(mco)
```

# Test para escoger el mejor modelo

## 1. F test
*  H0: modelo (MCO) vs H1: efectos fijos
* p<0.05 entonces rechazo Ho, el mejor modelo seria efectos fijos
```{r}
pFtest(fijos, mco) 
```

## 2. Breusch-Pagan
* H0: modelo agrupado (MCO) vs H1: efectos aleatorios
* p<0.05 entonces rechazo la Ho, por ahora el mejor modelo seria aleatorios
```{r}
plmtest(mco_pool, type=c("bp"))
```

## 3. Hausman test 
* H0: efectos aleatorios vs H1: efectos fijos
* p<0.05 entonces rechazo Ho y decido que efectos fijos es mejor
```{r}
phtest(fijos, random)
```

# Regresiones
## Regresieon con efectos fijos

### by pais Spain

```{r}
df_panel$pais <- relevel(df_panel$pais, ref = "Spain")
regresion_pais_sp = lm(Y ~ X + factor(pais), data = df_panel)

# summary(regresion_pais)


p_values <- summary(regresion_pais_sp)$coefficients[,4]
coeficiente <- summary(regresion_pais_sp)$coefficients[,1]

no_significativo <- names(p_values)[which(p_values > 0.05)]

significativo_positivos <- names(p_values)[which(p_values < 0.05 & coeficiente>0)]

significativo_negativos <- names(p_values)[which(p_values < 0.05 & coeficiente<0)]
```

### Analizando significancias
```{r}
no_significativo
```

```{r}
significativo_positivos
```

```{r}
significativo_negativos
```

### Supuestos
* normalidad
```{r}
# summary(regresion_pais_sp)
shapiro.test(resid(regresion_pais_sp))

```

*homocedasticidad
```{r}

bptest(regresion_pais_sp)

```

```{r}
dwtest(regresion_pais_sp)

```
* multicolinealidad
```{r}

vif(regresion_pais_sp)
```




### By year
* El año en sí mismo no parece tener un efecto significativo en Y después de ajustar por X
```{r}
regresion_years = lm(Y~X+factor(year))
summary(regresion_years)
```
```{r}
library(ggthemes)
df_panel_sum <- df_panel %>%
  group_by(year) %>%
  summarise(TG_sum = sum(TG, na.rm = TRUE))

# Asegúrate de que 'year' sea una variable numérica o de fecha
df_panel_sum$year <- as.numeric(as.character(df_panel_sum$year))

ggplot(df_panel_sum, aes(x = year, y = TG_sum)) +
  geom_line(aes(group = 1)) + # Añade group = 1 para conectar todos los puntos
  geom_point() +
  labs(x = "Year", y = "Total Earnings") +
  theme(legend.position = "top") +
  ggtitle("Ingresos Totales por Año")+
  theme_economist() +
  scale_color_economist()
```
```{r}
ggplot(df_panel %>%
  filter(pais %in% c('China', 'United States', 'Russian Federation',
                        'Korea, Republic of', 'France')),
  aes(x = year, y = TG, group = pais, color = pais)) +
  geom_line() +
  geom_point() +
  labs(x = "Year", y = "Total Earnings") +
  ggtitle("Ingresos Totales por Año")+
  theme_economist() +
  theme(legend.position = "left", 
        legend.key.size = unit(1, 'lines'), # Ajusta este valor según necesites
        legend.text = element_text(size = 10), # Ajusta este valor según necesites
        legend.title = element_text(size = 12)) # Ajusta este valor según necesites
  # scale_color_economist()
```

```{r}
 df_panel %>%
  group_by(pais) %>%
  top_n(5, TG) %>%
  arrange(desc(TG))%>%
  distinct(pais)
```

```{r}
library(ggrepel) 
ggplot(df_panel%>%
         mutate(
           top = ifelse(pais %in% c('China','United States', 'Russian Federation',
                                       'Korea, Republic of', 'France', 'Brazil',
                                       'Denmark','Ukraine', 'Japan', 'Finland'), TRUE, FALSE)),
       aes(x = year, y = TG, group = pais, color=top)) +
  geom_line(aes(size=top)) +
  # geom_smooth(method = "lm", aes(color = NULL, group = NULL), 
  #             color = "grey60", size = 1, linetype = "21",
  #             se = FALSE, show.legend = FALSE) +
  geom_label_repel(data = filter(df_panel%>%
                                   mutate(
                                     top = ifelse(pais %in% c('China','United States', 'Russian', 'Federation','Korea, Republic of', 'France', 'Brazil',
                                       'Denmark','Ukraine', 'Japan', 'Finland'), TRUE, FALSE)),
                                 year == 0, top == TRUE),
                   aes(label = pais), direction = "y", size = 0.1, seed = 1234,
                   show.legend = FALSE) +
  # annotate(geom = "label", label = "Global trend", x = 1952, y = 50,
  #          size = 3, color = "grey60") +
  scale_size_manual(values = c(0.075, 1), guide = "none") +
  # scale_color_okabe_ito(order = c(2, 3, 6, 1)) +
  labs(x = NULL, y = "Life expectancy") 
  # theme_clean() +
  # theme(legend.position = "bottom")
```

